subpackage:
  - runtime*
name: carnotzet+os-rpi4b
version: 0.1.0-53
$version: 0.1.0
distribution: raspberry/
maintainer:
  name: Mathieu Schroeter
  email: schroeter@epsitec.ch
architecture:
  - source
description:
  brief: Carnotzet Operating System
  long: ''
dependency:
  install:
    carnotzet+rootfs-rpi4b:
      - version: ''
        architecture: []
    carnotzet+rescuefs-rpi4b:
      - version: ''
        architecture: []
    raspberry+rpi4b-linux-kernel:
      - version: ''
        architecture: []
    raspberry+rpi4b-linux-firmware:
      - version: ''
        architecture: []
    raspberry+rpi4b-uboot:
      - version: ''
        architecture: []
    raspberry+rpi4b-firmware:
      - version: ''
        architecture: []
    gnu+glibc-rpi4b:
      - version: ''
        architecture: []
    gnu+libstdcxx-rpi4b:
      - version: ''
        architecture: []
    vlasenko+busybox-rpi4b:
      - version: ''
        architecture: []
    tytso+e2fsprogs-rpi4b:
      - version: ''
        architecture: []
    dosfstools+dosfstools-rpi4b:
      - version: ''
        architecture: []
    unigw+wpkg-rpi4b:
      - version: ''
        architecture: []
    linux+util-linux-rpi4b:
      - version: ''
        architecture: []
    malinen+wpa-supplicant-rpi4b:
      - version: ''
        architecture: []
  build:
    tytso+e2fsprogs:
      - version: ''
        architecture: []
    linux+util-linux:
      - version: ''
        architecture: []
    gnu+mtools:
      - version: ''
        architecture: []
    e2tools+e2tools:
      - version: ''
        architecture: []
    debian+fakeroot:
      - version: ''
        architecture: []
bump: []
data:
  get:
    uri: ''
    mirrors: []
    ref: ''
    $ref: ''
    out: ''
    externals: false
    prepare: ''
  type: src
  configure: ''
  rules:
    type: script
    location: ''
    args:
      postinst: ''
      prerm: ''
      makeall: |-
        function* genRoot (rootDir, pkgs) {
          rm(rootDir);
          mkdir(rootDir);

          /* Prepare the WPKG admin directory */
          yield exec(
            'wpkg_static',
            '--root', rootDir,
            '--create-admindir', '<PEON.ASSETS>/admindir.control'
          );
          /* Add the Xcraft Raspberry WPKG source */
          yield exec(
            'wpkg_static',
            '--root', rootDir,
            '--add-sources', 'wpkg http://127.0.0.1:12321/ raspberry/'
          );
          /* Update the WPKG indices */
          yield exec(
            'wpkg_static',
            '--root', rootDir,
            '--update'
          );
          /* Deploy the packages */
          yield exec(
            'wpkg_static',
            '--keep-original-symlink-target',
            '--force-file-info',
            '--skip-hooks',
            '--root', rootDir,
            '--install', ...pkgs
          );
          /* Deploy global hooks */
          yield exec(
            'wpkg_static',
            '--root', rootDir,
            '--add-hooks', '<PEON.ASSETS>/postinst'
          );
        }

        yield cmd('pacman.syncRepository', {distribution: 'raspberry'});

        /* Generate the root for the MMC */
        yield* genRoot('carnotzet', [
          'carnotzet+rootfs-rpi4b-x+bin',
          'carnotzet+rescuefs-rpi4b-x+bin',
          'raspberry+rpi4b-linux-kernel-x+bin',
          'raspberry+rpi4b-linux-firmware-x+bin',
          'raspberry+rpi4b-uboot-x+bin',
          'raspberry+rpi4b-firmware-x+bin',
          'gnu+glibc-rpi4b-x+bin',
          'gnu+libstdcxx-rpi4b-x+bin',
          'vlasenko+busybox-rpi4b-x+bin',
          'linux+util-linux-rpi4b-x+bin',
          'tytso+e2fsprogs-rpi4b-x+bin',
          'dosfstools+dosfstools-rpi4b-x+bin',
          'malinen+wpa-supplicant-rpi4b-x+bin',
          'unigw+wpkg-rpi4b-x+bin'
        ]);

        yield exec('sh', '-c', 'fallocate -l 1G carnotzet.img');
        yield exec('sh', '-c', 'printf "label: dos\n63,524225,0x0C,*\n524288,,,-\n" | sfdisk carnotzet.img');
        yield exec('sh', '-c', 'mformat -i carnotzet.img@@32256 -F -v BOOT :: -N 0 -T 524225');
        yield exec('sh', '-c', 'mcopy -i carnotzet.img@@32256 -s carnotzet/boot/* ::');

        rm('carnotzet/boot');
        mkdir('carnotzet/boot');
        yield exec('sh', '-c', 'fakeroot mke2fs -t ext4 -b 4096 -d carnotzet -E offset=268435456 carnotzet.img 196608');

        mv('carnotzet.img', '<PEON.INSTALLDIR>/opt/img/carnotzet-os-<THIS.$VERSION>.img');
      maketest: ''
      makeinstall: ''
    test: none
    env: {}
  deploy: ''
  env:
    path: []
    other: {}
  embedded: true
  runtime:
    configure: ''
